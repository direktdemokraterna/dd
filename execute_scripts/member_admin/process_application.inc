<?php 

if($_POST['accept']){
	if(!filter_var($_POST['email'], FILTER_VALIDATE_EMAIL)){
		$_SESSION['report_message'] = "Mejladressen var inte korrekt.";
		$_SESSION['red_report_message'] = 1;
	}
	else{
		$region = db_helpers::get_region_from_county($_POST['county']);
		
		require("helpers/class-phpass.php");
		$random_password = general_helpers::GenerateRandomString(12);
		$hasher = new PasswordHash(8, FALSE);
		$password = $hasher->HashPassword($random_password);
		
		$ok = db_user::add_user(general_helpers::clean($_POST['username']), $password, general_helpers::clean($_POST['first_name']), general_helpers::clean($_POST['last_name']), general_helpers::clean($_POST['street_address']), (int)$_POST['zip_code'], general_helpers::clean($_POST['city_address']), $_POST['county'], $region, general_helpers::clean($_POST['social_security_number']), $_POST['email']);

		if($ok){
			db_user::delete_user_application($_GET['id']);

			$mail_receiver = $_POST['email'];
			$mail_title = "Vlkommen till Direktdemokraterna";
			$mail_text = "Du har blivit antagen som medlem i Direktdemokraterna och kan logga in p medlems-sidan.\n\nDina inloggningsuppgifter r fljande:\n\nAnvndarnamn: " . general_helpers::clean($_POST['username']) . "\nLsenord: " . $random_password;

			$mail_response = general_helpers::admin_mail($mail_receiver, $mail_title, $mail_text);
			if($mail_response != "success"){
				die($mail_response);
			}

			$_SESSION['report_message'] = "Anvndaren r skapad. Anvndaruppgifter har skickats via mejl till anvndaren.";
			$redirect = "index.php?type=member_admin&action=list_applications";
		}
		else{
			$_SESSION['report_message'] = "Ngot gick fel, ingen anvndare skapad.";
			$_SESSION['red_report_message'] = 1;
		}
	}
}

elseif($_POST['reject']){

	$application_data = db_user::get_user_application($_GET['id']);

	$ok = db_user::delete_user_application($_GET['id']);

	if($ok){
		$mail_receiver = $application_data['email'];
		$mail_title = "Din medlemsanskan till Direktdemokraterna har avslagits";
		$mail_text = "En medlemsadministratr har avslagit din medlemsanskan till Direktdemokraterna. Kontakta en medlemsadministratr fr att f veta mer eller lmna in en ny anskan.";

		general_helpers::admin_mail($mail_receiver, $mail_title, $mail_text);

		$_SESSION['report_message'] = "Medlemsanskan har avslagits.";
		$redirect = "index.php?type=member_admin&action=list_applications";
	}
	else{
		$_SESSION['report_message'] = "Ngot gick fel, ingen tgrd vidtagen.";
		$_SESSION['red_report_message'] = 1;		
	}

}

?>